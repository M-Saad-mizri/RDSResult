<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Development Program</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }

        h3 {
            text-align: center;
            font-size: 1.5em;
            margin: 20px 0;
            color: #333;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        #statistics {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        #statistics p {
            margin: 5px 0;
            font-size: 1em;
            color: #555;
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            font-size: 0.9em;
        }

        table th {
            background-color: #4CAF50;
            color: white;
        }

        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tr:hover {
            background-color: #f1f1f1;
        }

        /* Spinning loader animation */
        #loader {
            text-align: center;
            visibility: hidden;
            margin-top: 20px;
            font-size: 18px;
            color: #333;
        }

        #loader.show {
            visibility: visible;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Media Queries for smaller devices */
        @media (max-width: 768px) {
            h3 {
                font-size: 1.2em;
            }

            .container {
                width: 95%;
                padding: 15px;
            }

            table th, table td {
                padding: 10px;
                font-size: 0.85em;
            }

            select {
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            h3 {
                font-size: 1em;
            }

            .container {
                width: 90%;
                padding: 10px;
            }

            table th, table td {
                padding: 8px;
                font-size: 0.75em;
            }

            select {
                width: 95%;
                font-size: 0.9em;
            }

            #downloadbtn {width: 95%;}
        }
    </style>
</head>
<body>

    <h3>
        CHIEF MINISTER SKILL DEVELOPMENT AND OVERSEAS EMPLOYMENT PROGRAM<br>
        RECOMMENDED CANDIDATES FOR <br> IT / HEALTH CARE / HOSPITALITY SECTOR AT EU / GERMANY <br>BY 
        RADIUS CONSULTANT
    </h3>

    <div class="container">

        <!-- <a href="overall Result final.xlsx" download="overall Result final.xlsx">
            <button id="downloadbtn" style="padding: 10px 20px; font-size: 16px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                Download Final Result (Excel)
            </button>
        </a> <hr> -->
        <h3>Female Statistics</h3>
        <p><strong>Total Females:</strong> <span id="Total-Females">0</span></p>
        <p><strong>Fail Females:</strong></strong> <span id="Pass-Females">0</span></p>
        <div class="search-container">
            <label for="filterInputdistric">Search District:</label>
            <input type="text" id="filterInputdistric" placeholder="Enter district name..." onkeyup="filterDistricts()">
        </div>
        
        <div style="height: 100px; overflow-y: auto; width: 100%; margin-top: 10px;">
        <table id="districtTable">
            <thead>
                <tr>
                    <th>District</th>
                    <th>Total Females</th>
                    <th>Fail Females</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Awaran</td><td>1</td><td>0</td></tr>
                <tr><td>Barkhan</td><td>0</td><td>0</td></tr>
                <tr><td>Chaghi</td><td>0</td><td>0</td></tr>
                <tr><td>Chaman</td><td>2</td><td>1</td></tr>
                <tr><td>Dera Bugti</td><td>0</td><td>0</td></tr>
                <tr><td>GWADER</td><td>0</td><td>0</td></tr>
                <tr><td>Harnai</td><td>0</td><td>0</td></tr>
                <tr><td>HUB</td><td>2</td><td>1</td></tr>
                <tr><td>Jaffarabad</td><td>0</td><td>0</td></tr>
                <tr><td>Jhal Magsi</td><td>0</td><td>0</td></tr>
                <tr><td>Kalat</td><td>2</td><td>2</td></tr>
                <tr><td>Kachhi</td><td>2</td><td>0</td></tr>
                <tr><td>Kech</td><td>1</td><td>0</td></tr>
                <tr><td>Khuzdar</td><td>3</td><td>0</td></tr>
                <tr><td>Killa Abdullah</td><td>0</td><td>0</td></tr>
                <tr><td>Killa Saifullah</td><td>0</td><td>0</td></tr>
                <tr><td>Kohlu</td><td>1</td><td>0</td></tr>
                <tr><td>Lasbella</td><td>0</td><td>0</td></tr>
                <tr><td>Loralai</td><td>0</td><td>0</td></tr>
                <tr><td>Mastung</td><td>2</td><td>0</td></tr>
                <tr><td>Musakhel</td><td>0</td><td>0</td></tr>
                <tr><td>Naseerabad</td><td>1</td><td>0</td></tr>
                <tr><td>Nushki</td><td>2</td><td>0</td></tr>
                <tr><td>Panjgur</td><td>0</td><td>0</td></tr>
                <tr><td>Pishin</td><td>0</td><td>0</td></tr>
                <tr><td>Quetta</td><td>7</td><td>2</td></tr>
                <tr><td>Sibi</td><td>0</td><td>0</td></tr>
                <tr><td>Sohbatpur</td><td>0</td><td>0</td></tr>
                <tr><td>Surab</td><td>1</td><td>1</td></tr>
                <tr><td>Usta Muhammad</td><td>0</td><td>0</td></tr>
                <tr><td>Washuk</td><td>0</td><td>0</td></tr>
                <tr><td>Ziarat</td><td>1</td><td>0</td></tr>
                <tr><td>Kharan</td><td>0</td><td>0</td></tr>
            </tbody>
        </table>
    </div> <hr>
    <h3>Overall Statistics</h3>
        <div id="statistics">
            <p><strong>Total Students:</strong> <span id="totalStudents">0</span></p>
            <p><strong>Pass:</strong> <span id="passCount">0</span></p>
            <p><strong>Fail:</strong> <span id="failCount">0</span></p>
        </div>
        <h3><img width="20" height="20" src="https://img.icons8.com/fluency/48/filter--v1.png" alt="filter--v1"/>District and Field</h3>

        <select style="margin-bottom: 10px;" id="district" onchange="filterData()">
            <option value="">All Districts</option>
        </select>

        <select id="field" onchange="filterData()">
            <option value="">All Fields</option>
            <option value="IT">IT</option>
            <option value="Health">Health</option>
            <option value="Hospitality">Hospitality</option>
        </select> <br>
        <label>
            <input type="checkbox" id="filterQualified" onchange="filterTable()" /> Qualified
        </label>
        <label>
            <input type="checkbox" id="filterNotQualified" onchange="filterTable()" /> Not Qualified
        </label>

        <!-- Loader -->
        <div id="loader" class="spinner"></div>
        <span>Search: </span><input type="text" id="searchInput" placeholder="Search by name or NIC" onkeyup="filterTable_main()" />
        <div class="table-container">
            <table id="resultTable" border="1" style="width: 100%; text-align: left;">
                <!-- Table will be dynamically populated -->
            </table>
            <button style="margin-top: 10px;" id="downloadPdfBtn">Download PDF</button>
        </div>

    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
function filterDistricts() {
    // Get the filter input value
    const filterValue = document.getElementById('filterInputdistric').value.toLowerCase();
    
    // Get the table and its rows
    const table = document.getElementById('districtTable');
    const rows = table.getElementsByTagName('tr');

    // Loop through table rows (start from index 1 to skip the header)
    for (let i = 1; i < rows.length; i++) {
        const districtCell = rows[i].getElementsByTagName('td')[0];
        if (districtCell) {
            // Check if the district matches the filter value
            const districtText = districtCell.textContent || districtCell.innerText;
            if (districtText.toLowerCase().indexOf(filterValue) > -1) {
                rows[i].style.display = ''; // Show the row
            } else {
                rows[i].style.display = 'none'; // Hide the row
            }
        }
    }
}
function filterTable() {
            const filterQualified = document.getElementById("filterQualified").checked;
            const filterNotQualified = document.getElementById("filterNotQualified").checked;
            const table = document.getElementById("resultTable");
            const rows = table.getElementsByTagName("tr");

            for (let i = 1; i < rows.length; i++) { // Start from 1 to skip the header row
                const statusCell = rows[i].getElementsByTagName("td")[5]; // Status is in the 5th column

                if (statusCell) {
                    const statusText = statusCell.textContent || statusCell.innerText;

                    // Default: Show all rows if no filters are selected
                    if (!filterQualified && !filterNotQualified) {
                        rows[i].style.display = ""; // Show all rows
                        continue; // Skip to the next row
                    }

                    // Apply filters
                    let shouldShowRow = false;
                    if (filterQualified && statusText === "Qualified") {
                        shouldShowRow = true;
                    }
                    if (filterNotQualified && statusText === "Not Qualified") {
                        shouldShowRow = true;
                    }

                    // Show or hide the row based on the filter
                    rows[i].style.display = shouldShowRow ? "" : "none";
                }
            }
        }
        // Fetch data on page load
        window.onload = function() {
            fetchData();
        };

        // Function to fetch data from API
        function fetchData() {
            document.getElementById('loader').classList.add('show'); // Show loader

            fetch('https://script.google.com/macros/s/AKfycbwIOjxTdxzCgqNYfPhi4o3rYLDijtxnUWw4jhnZAZ3tFZTkvNZ5KYd8dG39KMmmMmue/exec')
                .then(response => response.json())
                .then(data => {
                    studentData = data;
                    console.log('Fetched data:', studentData[studentData.length-1][8]); 
                    populateTable(studentData); // Populate table with all data
                    updateStatistics(studentData); // Update overall statistics
                    populateDistricts(studentData); // Populate district dropdown
                    document.getElementById('loader').classList.remove('show'); // Hide loader
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('loader').classList.remove('show'); // Hide loader
                });
        }

        let totalFemales = 0;
        let passFemales = 0;

        // Function to update overall statistics
        function updateStatistics(data, updateFemales = true) {
            const totalStudents = data.length;
            const passCount = data.filter(row => row[7] >= 50).length; // Assuming column 7 is the final score
            const failCount = totalStudents - passCount;

            // Update main statistics
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;

            // Update Total Females and Pass Females only when updateFemales is true
            if (updateFemales) {
                passFemales = studentData[studentData.length-1][8]; // 'Pass Female' count
                totalFemales = studentData[studentData.length-1][9] // 'Total Female' count

                document.getElementById('Pass-Females').textContent = passFemales;
                document.getElementById('Total-Females').textContent = totalFemales;
            }
        }

        // Function to populate the table with API data

    // Populate Table Function
    function populateTable(data) {
        const table = document.getElementById('resultTable');
        table.innerHTML = ''; // Clear existing table data

        // Add headers without "Total Marks" but with a new "Status" column
        const headers = `
            <tr>
                <th>Name</th>
                <th>Father Name</th>
                <th>NIC</th>
                <th>District</th>
                <th>Field</th>
                <th>Status</th>
            </tr>
        `;
        table.innerHTML = headers;

        // Populate rows
        data.forEach(row => {
            const mcqMarks = row[5] || 0;
            const essayMarks = row[6] || 0;
            const totalMarks = mcqMarks + essayMarks;

            let status = '';
            let rowColor = '';

            if (totalMarks === 0 || mcqMarks === '' || essayMarks === '') {
                status = 'Absent';
                rowColor = 'lightgray';
            } else if (totalMarks >= 50) {
                status = 'Qualified';
                rowColor = 'lightgreen';
            } else {
                status = 'Not Qualified';
                rowColor = 'lightcoral';
            }

            const rowHTML = `
                <tr style="background-color: ${rowColor};">
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                    <td>${row[4]}</td>
                    <td>${status}</td>
                </tr>
            `;
            table.innerHTML += rowHTML;
        });
    }

    // Function to download the table as a PDF
    async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const table = document.getElementById('resultTable');
    const headers = ['Name', 'Father Name', 'NIC', 'District', 'Field', 'Status'];

    // Group rows by district
    const districts = {};
    const allRows = [];
    for (let i = 1; i < table.rows.length; i++) {
        const row = Array.from(table.rows[i].cells).map(cell => cell.textContent);
        allRows.push(row);
        const district = row[3]; // District is the 4th column

        if (!districts[district]) {
            districts[district] = [];
        }
        districts[district].push(row);
    }

    // Calculate overall statistics
    const totalStudents = allRows.length;
    const absentStudents = allRows.filter(row => row[5] === 'Absent').length; // Count absent students
    const filteredRows = allRows.filter(row => row[5] !== 'Absent'); // Exclude absent students for pass/fail
    let totalPass = 0;
    let totalFail = 0;

    filteredRows.forEach(row => {
        const status = row[5]; // Status is the 6th column
        if (status === 'Qualified') totalPass++;
        if (status === 'Not Qualified') totalFail++;
    });

    // Calculate field-wise statistics
    const fieldCounts = {};
    filteredRows.forEach(row => {
        const field = row[4]; // Field is the 5th column
        const status = row[5]; // Status is the 6th column

        if (!fieldCounts[field]) {
            fieldCounts[field] = { Pass: 0, Fail: 0 };
        }

        if (status === 'Qualified') {
            fieldCounts[field].Pass++;
        } else if (status === 'Not Qualified') {
            fieldCounts[field].Fail++;
        }
    });

    // Add the overall summary page
    doc.setFontSize(16);
    doc.text('Overall Result Summary', 14, 20);

    doc.setFontSize(12);
    doc.text(`Total Students: ${totalStudents}`, 14, 30);
    doc.text(`Total Absent: ${absentStudents}`, 14, 40);
    doc.text(`Total Pass: ${totalPass}`, 14, 50);
    doc.text(`Total Fail: ${totalFail}`, 14, 60);

    let yOffset = 70;
    doc.text('Field-wise Pass and Fail Counts:', 14, yOffset);
    yOffset += 10;

    Object.entries(fieldCounts).forEach(([field, counts]) => {
        doc.text(`${field}: Pass = ${counts.Pass}, Fail = ${counts.Fail}`, 14, yOffset);
        yOffset += 10;
    });

    // Create a summary table for districts
    const districtSummary = [];

    Object.entries(districts).forEach(([district, rows], index) => {
        // Calculate total students and absent students for the district
        const districtTotalStudents = rows.length;
        const districtAbsentStudents = rows.filter(row => row[5] === 'Absent').length;
        const districtFilteredRows = rows.filter(row => row[5] !== 'Absent'); // Exclude absent students

        let districtTotalPass = 0;
        let districtTotalFail = 0;

        districtFilteredRows.forEach(row => {
            const status = row[5];
            if (status === 'Qualified') districtTotalPass++;
            if (status === 'Not Qualified') districtTotalFail++;
        });

        // Add district summary to the array
        districtSummary.push([index + 1, district, districtTotalStudents, districtTotalPass, districtTotalFail, districtAbsentStudents]);
    });

    // Add district summary table at the beginning
    doc.addPage(); // Add a new page for the summary

    doc.setFontSize(16);
    doc.text('District Summary', 14, 20);

    const summaryHeaders = ['Serial No.', 'District', 'Total Students', 'Pass Students', 'Fail Students', 'Absent Students'];

    doc.autoTable({
        startY: 30,
        head: [summaryHeaders],
        body: districtSummary,
        styles: {
            fontSize: 10,
            cellPadding: 3,
            halign: 'center',
            valign: 'middle',
        },
        headStyles: { fillColor: [0, 102, 204] },
    });

    // Add district-wise details after the summary
    Object.entries(districts).forEach(([district, rows], index) => {
        doc.addPage(); // Add a new page for each district

        // Calculate total students and absent students for the district
        const districtTotalStudents = rows.length;
        const districtAbsentStudents = rows.filter(row => row[5] === 'Absent').length;
        const districtFilteredRows = rows.filter(row => row[5] !== 'Absent'); // Exclude absent students

        let districtTotalPass = 0;
        let districtTotalFail = 0;

        districtFilteredRows.forEach(row => {
            const status = row[5];
            if (status === 'Qualified') districtTotalPass++;
            if (status === 'Not Qualified') districtTotalFail++;
        });

        // Add district name and counts at the top
        doc.setFontSize(16);
        doc.text(`District: ${district}`, 14, 20);

        doc.setFontSize(12);
        doc.text(`Total Students: ${districtTotalStudents}`, 14, 30);
        doc.text(`Total Absent: ${districtAbsentStudents}`, 14, 40);
        doc.text(`Total Pass: ${districtTotalPass}`, 14, 50);
        doc.text(`Total Fail: ${districtTotalFail}`, 14, 60);

        // Add the table for the current district
        doc.autoTable({
            startY: 70,
            head: [headers],
            body: rows,
            styles: {
                fontSize: 10,
                cellPadding: 3,
                halign: 'center',
                valign: 'middle',
            },
            headStyles: { fillColor: [0, 102, 204] },
        });
    });

    // Save the PDF
    doc.save('Districts_Report.pdf');
}

// Attach the event listener to the button
document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);

function filterTable_main() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('resultTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) { // Start from 1 to skip the header row
        const cells = rows[i].getElementsByTagName('td');
        let match = false;

        // Check if any cell contains the filter text
        for (let j = 0; j < cells.length; j++) {
            if (cells[j].innerText.toLowerCase().includes(filter)) {
                match = true;
                break;
            }
        }

        rows[i].style.display = match ? '' : 'none'; // Show or hide row based on match
    }
}


        // Function to populate district dropdown
        function populateDistricts(data) {
            const districts = [...new Set(data.map(row => row[3]))]; // Assuming column 3 contains district names
            const districtSelect = document.getElementById('district');
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }

        // Function to filter data based on selected district and field
        function filterData() {
            const selectedDistrict = document.getElementById('district').value;
            const selectedField = document.getElementById('field').value;

            // Filter data
            const filteredData = studentData.filter(row => {
                return (selectedDistrict === '' || row[3] === selectedDistrict) && 
                       (selectedField === '' || row[4] === selectedField);
            });

            populateTable(filteredData); // Update table with filtered data
            updateStatistics(filteredData, false); // Update statistics based on filtered data
        }
    </script>

</body>
</html>
